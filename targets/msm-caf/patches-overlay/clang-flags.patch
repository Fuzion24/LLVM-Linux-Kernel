From f37a03ad600cd4f1edaaefa2364077cfa8fdebe0 Mon Sep 17 00:00:00 2001
From: Mark Charlebois <charlebm@gmail.com>
Date: Thu, 14 Aug 2014 08:12:08 -0500
Subject: [PATCH] DO-NOT-UPSTREAM kbuild: LLVMLinux: Optionally include flags
 not supported by clang

Clang doesn't support -fno-delete-null-pointer-checks or
 -fno-inline-functions-called-once and they cannot be
diabled by cc-option because cc-option doesnt work for
flags, ony for warnings.

Signed-off-by: Mark Charlebois <charlebm@gmail.com>
Signed-off-by: Behan Webster <behanw@converseincode.com>
---
 Makefile | 10 +++++++---
 1 file changed, 7 insertions(+), 3 deletions(-)

--- msm.orig/Makefile
+++ msm/Makefile
@@ -244,6 +244,11 @@
 HOSTCFLAGS   = -Wall -Wmissing-prototypes -Wstrict-prototypes -O2 -fomit-frame-pointer
 HOSTCXXFLAGS = -O2
 
+ifeq ($(shell $(HOSTCC) -v 2>&1 | grep -c "clang version"), 1)
+HOSTCFLAGS  += -Wno-unused-value -Wno-unused-parameter \
+		-Wno-missing-field-initializers
+endif
+
 # Decide whether to build built-in, modular, or both.
 # Normally, just do built-in.
 
@@ -385,9 +390,12 @@
 KBUILD_CFLAGS   := -Wall -Wundef -Wstrict-prototypes -Wno-trigraphs \
 		   -fno-strict-aliasing -fno-common \
 		   -Werror-implicit-function-declaration \
-		   -Wno-format-security \
-		   $(call cc-option,-no-integrated-as,) \
-		   -fno-delete-null-pointer-checks
+		   -Wno-format-security
+ifneq ($(COMPILER),clang)
+KBUILD_CFLAGS	+= no-integrated-as
+KBUILD_CFLAGS	+= -fno-delete-null-pointer-checks
+endif
+
 KBUILD_AFLAGS_KERNEL :=
 KBUILD_CFLAGS_KERNEL :=
 KBUILD_AFLAGS   := -D__ASSEMBLY__ $(call cc-option,-no-integrated-as,)
@@ -670,7 +678,9 @@
 
 # We trigger additional mismatches with less inlining
 ifdef CONFIG_DEBUG_SECTION_MISMATCH
-KBUILD_CFLAGS += $(call cc-option, -fno-inline-functions-called-once)
+ifneq ($(COMPILER),clang)
+KBUILD_CFLAGS += -fno-inline-functions-called-once
+endif
 endif
 
 # arch Makefile may override CC so keep this after arch Makefile is included
