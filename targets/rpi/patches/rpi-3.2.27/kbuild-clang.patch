Add Clang support to Kbuild

Do not upstream this patch. Clang behavior is likely to change

Signed-off-by: Mark Charlebois <charlebm@gmail.com>
---
 Makefile.build |    1 +
 2 files changed, 18 insertions(+), 5 deletions(-)

--- rpi.orig/scripts/Makefile.build
+++ rpi/scripts/Makefile.build
@@ -72,6 +72,7 @@
 #warning-1 += $(call cc-option, -Wunused-but-set-variable)
 warning-1 += -Wno-unused-value -Wno-format -Wno-unknown-warning-option -Wno-self-assign
 warning-1 += -fcatch-undefined-behavior -Wno-sign-compare -Wno-format-zero-length -Wno-uninitialized
+warning-1 += $(call cc-option, -Wunused-value)
 
 warning-2 := -Waggregate-return
 warning-2 += -Wcast-align
--- rpi.orig/scripts/Kbuild.include
+++ rpi/scripts/Kbuild.include
@@ -122,11 +122,23 @@
 cc-option-align = $(subst -functions=0,,\
 	$(call cc-option,-falign-functions=0,-malign-functions=0))
 
+# Test for clang
+ifeq ($(shell $(CC) -v 2>&1 | grep -c "clang version"), 1)
+# cc-disable-warning
+# Usage: cflags-y += $(call cc-disable-warning,unused-but-set-variable)
+cc-disable-warning = $(call try-run,\
+	$(CC) $(KBUILD_CPPFLAGS) $(KBUILD_CFLAGS) -W$(strip $(1)) -c -xc /dev/null -o "$$TMP" 2>&1 | grep -q "unknown warning option",,-Wno-$(strip $(1)))
+
+# Otherwise assume GCC or something compatible
+else
+
 # cc-disable-warning
 # Usage: cflags-y += $(call cc-disable-warning,unused-but-set-variable)
 cc-disable-warning = $(call try-run,\
 	$(CC) $(KBUILD_CPPFLAGS) $(KBUILD_CFLAGS) -W$(strip $(1)) -c -xc /dev/null -o "$$TMP",-Wno-$(strip $(1)))
 
+endif
+
 # cc-version
 # Usage gcc-ver := $(call cc-version)
 cc-version = $(shell $(CONFIG_SHELL) $(srctree)/scripts/gcc-version.sh $(CC))
--- rpi.orig/Makefile
+++ rpi/Makefile
@@ -633,6 +633,9 @@
 # conserve stack if available
 KBUILD_CFLAGS   += $(call cc-option,-fconserve-stack)
 
+# Quiet unused arguments warning from clang
+KBUILD_CFLAGS   += $(call cc-option,-Qunused-arguments)
+
 # use the deterministic mode of AR if available
 KBUILD_ARFLAGS := $(call ar-option,D)
 
