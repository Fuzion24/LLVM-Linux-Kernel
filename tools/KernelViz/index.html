<!doctype html>
<!--
##############################################################################
# Copyright (c) 2014 Mark Charlebois
#
# All rights reserved. 
#
# Redistribution and use in source and binary forms, with or without
# modification, are permitted (subject to the limitations in the disclaimer
# below) provided that the following conditions are met:
# 
# * Redistributions of source code must retain the above copyright notice,
#   this list of conditions and the following disclaimer.
#  
# * Redistributions in binary form must reproduce the above copyright notice,
#   this list of conditions and the following disclaimer in the documentation
#   and/or other materials provided with the distribution.
# 
# * Neither the name KernelViz nor the names of its contributors may be used
#   to endorse or promote products derived from this software without 
#   specific prior written permission.
# 
# NO EXPRESS OR IMPLIED LICENSES TO ANY PARTY'S PATENT RIGHTS ARE GRANTED BY
# THIS LICENSE. THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND
# CONTRIBUTORS "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT
# NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A
# PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR
# CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL,
# EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO,
# PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS;
# OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY,
# WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR
# OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF
# ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
##############################################################################
<!-->
<html lang="en">
<head>
<meta charset="utf-8">
</head>
<script src="external/d3/d3.v3.js"></script>
<script src="external/dagre/dagre-d3.js"></script>
<script src="external/completely/complete.ly.1.0.1.min.js"></script>
<script src="scripts/ForceGraph.js"></script>
<script src="scripts/DirectedGraph.js"></script>
<script src="scripts/DirView.js"></script>
<script src="scripts/ModuleView.js"></script>
<script>
var msgid = 0;
var files = [];
var funclist = [];
var width = window.innerWidth - 290.0;
var height = 1000;
var View = null;

var linkColor = { "Call Out": "#d62728", "Call In": "#2ca02c" };

// -------------------------------------------------------------
// FunctionView
// -------------------------------------------------------------
function FunctionView(svgclass, viewinfoclass, selectorclass) {
  var subGraphData = null;
  var selectedNode = null;
  var graphTypeIsDirected = true;
  var showingGraph = false;
  var nodeColor = { "External": "#f77", "Global": "#177", "Local": "#fff", "Local Unused": "#771", "Exported": "#717" };
  var functionSelector;

  function clickDGNode(label, obj) {
    if (label == selectedNode) {
      selectedNode = null;
      d3.selectAll("div.nodeInfo").html("");
    } else {
      // Select this node
      selectedNode = label;
      displayNodeInfo(obj);
    }
    _dg.selectedNode = selectedNode;
  }

  function DGNodeAttrFn(label, obj) { 
    var funcType = getFunctionType(label);
    var rect = obj.getElementsByTagName('rect');
    rect[0].style.fill = nodeColor[funcType];
    return funcType;
  }

  var _dg = new DirectedGraph(clickDGNode, "functype", DGNodeAttrFn);

  this.loadSubGraph = function(func, depth) {
    _loadSubGraph(func, depth);
  }

  function _loadSubGraph(func, depth) {
    functionSelector.setText(func);
    setTimeout(function() { getSubGraph(func, depth); },0);
  }

  function selectNewFunction(func) {
    if (funclist.indexOf(func) >= 0) 
      // TODO: Get depth from widget
      _loadSubGraph(func, 2);
    else {
      if (showingGraph) {
        clearGraph();
        showingGraph=false;
      }
    }
  }

  function clickFunction() {
      loadSubGraph(document.getElementById("funcname").value, 2);
  }

  this.addFunctionSelector = function() {

    //var selector = document.getElementById("funcselector");
    //selector.innerHTML = "Type in a Function Name or Select From List:&nbsp;" +
    //  "<input type='text' id='funcname' style='width:400'/>" +
    //  "<button onclick='clickFunction()'>ClickMe</button>"
  }

  function clearGraph() {
    // Remove existing svg 
    // Can be used to get rid of zoom
    var div = d3.select("div.container");
    div.selectAll("svg").remove();
    div.append("svg");
    resize();
    graph = null;
  }

  this.setActive = function() {
    clearGraph();
    if (showingGraph)
      createGraph();

    makeViewInfo();
  }

  function createGraph() {
    d3.select("div.labelbutton").style("display", graphTypeIsDirected ? "none" : null);
    svg = d3.selectAll("svg");
    svg.selectAll("g").remove();
    graph = _dg.createGraph(svg, subGraphData);
    showingGraph = true;
  }

  this.resize = function(width, height) {
    height = width;
  }

  function makeViewInfo() {
    d3.select("div.labelbutton").style("display", "none");

    var viewinfo = d3.select(viewinfoclass).html("");
    var table = viewinfo
      .append("div")
      .attr("class", "key")
      .append("table");

    var tablehead = table.append("tr");
    var tablebody = table.append("tbody");

    tablehead
      .append("th")
      .text("Function Type");

    tablehead
      .append("th")
      .text("Color");

    row = tablebody
      .selectAll("tr")
      .data(Object.keys(nodeColor)) 
      .enter()
      .append("tr");

    row
      .append("td")
      .attr("width", "100px")
      .text(function (d) { return d; });

    row
      .append("td")
      .attr("width", "50px")
      .attr("style", function (d) { return "background-color:"+nodeColor[d]+";"; } );

    viewinfo
      .append("div")
      .classed("nodeInfo", true);
  }

  function getSubGraph(func, depth) {
    xmlhttp = new XMLHttpRequest();
    xmlhttp.open("GET","getsubgraph?function="+func, true);
    xmlhttp.onreadystatechange=function() {
      if (xmlhttp.readyState==4 && xmlhttp.status==200){
        subGraphData = JSON.parse(xmlhttp.responseText);
        //graphTypeIsDirected = true;
        createGraph();
      }
    }
    xmlhttp.send();
  }

}

var functionView = new FunctionView("div.svg", "div.viewInfo", "div.selector");
var moduleView = new ModuleView("div.svg", "div.viewInfo", "div.selector");
var topDirView = new TopDirView("div.svg", "div.viewInfo");
View = moduleView;

window.addEventListener('resize', resize);

function resize() {
  width = window.innerWidth - 290.0;
  height = 1000;
  svg = d3.select("svg")
          .attr("style", "width:"+ width + "px;height:"+ height + "px;");
  View.resize(width, height);
  var selector = document.getElementById("selector");
  selector.style.width = width+"px";

};

function init() {
  getFiles();
  //getFunctions();
  setView("moduleview");
  resize();
}

function setView(view) {
  if (view == "toplevel") {
    d3.select("div.labelbutton").style("display", null);
    d3.select("div.viewbuttons").style("display", "none");
    d3.select("div.topviewcontrols").style("display", null);
    d3.select("div.selector").style("display", "none");
    d3.select("div.funcselector").style("display", "none");
    View = topDirView;
  } 
  else if (view == "func") {
    View = functionView;
    d3.select("div.labelbutton").style("display", null);
    d3.select("div.viewbuttons").style("display", null);
    d3.select("div.topviewcontrols").style("display", "none");
    d3.select("div.selector").style("display", "none");
    d3.select("div.funcselector").style("display", null);
  }
  else {
    View = moduleView;
    d3.select("div.labelbutton").style("display", null);
    d3.select("div.viewbuttons").style("display", null);
    d3.select("div.topviewcontrols").style("display", "none");
    d3.select("div.selector").style("display", null);
    d3.select("div.funcselector").style("display", "none");
  }

  View.setActive();
  View.resize();
}


// -- AJAX Functions

function getFiles() {
  xmlhttp = new XMLHttpRequest();
  xmlhttp.open("GET","getfiles", true);
  xmlhttp.onreadystatechange=function(){
    if (xmlhttp.readyState==4 && xmlhttp.status==200){
      var mytext = document.getElementById("mytext");
      files = JSON.parse(xmlhttp.responseText);
      moduleView.addModuleSelector();
    }
  }
  xmlhttp.send();
}

function getFunctions() {
  xmlhttp = new XMLHttpRequest();
  xmlhttp.open("GET","getfunctions", true);
  xmlhttp.onreadystatechange=function(){
    if (xmlhttp.readyState==4 && xmlhttp.status==200){
      var mytext = document.getElementById("mytext");
      funclist = JSON.parse(xmlhttp.responseText);
      functionView.addFunctionSelector();
    }
  }
  xmlhttp.send();
}

</script>
<style>
body {
  font-family: sans-serif;
  font-size: 14px;
}

.node rect {
  stroke: #333;
}

.selected rect {
  stroke-width: 4px;
  stroke: #00d;
}

.edgePath path {
  stroke: #333;
  fill: none;
}

.nodeInfo,
.linkKey,
.key {
  width: 230px;
  margin: 5px;
  padding: 5px;
  border: 1px solid #999;
  float: right;
}

.topbuttons,
.viewbuttons,
.labelbutton {
  width: 120px;
  margin: 5px;
  padding: 5px;
  border: 1px solid #999;
  float: left;
}

td {
  border:1px solid #999;
}

svg {
  border: 1px solid #999;
  overflow: hidden;
  background: -webkit-linear-gradient(white, rgba(100,100,255,10)); /* For Safari 5.1 to 6.0 */
  background: -o-linear-gradient(white, rgba(100,100,255,10)); /* For Opera 11.1 to 12.0 */
  background: -moz-linear-gradient(white, rgba(100,100,255,10)); /* For Firefox 3.6 to 15 */
  background: linear-gradient(white, rgba(100,100,255,10)); /* Standard syntax (must be last) */
}

.node-fg {
  stroke: #fff;
  fill: #fd9040;
  stroke-width: 1.5px;
}

.node-selected {
  stroke: #00d;
  stroke-width: 4px;
}

.link {
  stroke: #000;
  stroke-opacity: 1;
  stroke-width: 2px;
}

.label {
  pointer-events: none;
}

.selector{
    float: left;
    background: #fff;
    border: 1px solid #000;
    z-index: 1;
    width: 100%;
    margin-bottom: 5px;
}

.link-hidden {
   display: none;
}

.node-hidden {
   display: none;
}

.link-shadow {
  stroke: #222;
  stroke-opacity: .2;
}

.link-source,
.link-target {
  stroke-opacity: 1;
  stroke-width: 2px;
}

.link-source {
  stroke: #d62728;
}

.link-target {
  stroke: #2ca02c;
}

.nodeInfo {
  height: 400px;
}
</style>
<body onload="init()">
<div class="selector" id="selector"></div>
<div class="controls" style="float:right;width:250px">
  <div style="width:90px;float:right;">
    <img src="images/tux-with-dragon-wings-90.png"/>
  </div>
  <div class="topbuttons">
    <input type="radio" name="view" value="toplevel" onclick="setView(this.value)">Dir View</input><br/>
    <input type="radio" name="view" value="module" onclick="setView(this.value)" checked="true">ModuleView</input><br/>
    <input type="radio" name="view" value="func" onclick="setView(this.value)">FunctionView</input><br/>
  </div>
  <div class="viewbuttons">
    <input type='radio' name='graphtype' value='directed' onclick='moduleView.setGraphType(this.value)' checked='true'/>Directed Graph
    <br/>
    <input type='radio' name='graphtype' value='forced' onclick='moduleView.setGraphType(this.value)'/>Force Graph
    <br/>
  </div>
  <div class="labelbutton">
    <input type='checkbox' checked='true' onclick='View.showLabels(this.checked)'/>Show Labels
    <br/>
    <input type='checkbox' checked='true' onclick='View.enableZoom(this.checked)'/>Zoom
    <div class="topviewcontrols">
      <input type='checkbox' checked='true' onclick='topDirView.showLinks(this.checked)'/>Show Links
    </div>
  </div>
  <div class="viewInfo">
  </div>
</div>
<div class="container" style="float:left;">
  <svg>
    <g/>
  </svg>
</div>

</body>
</html>
